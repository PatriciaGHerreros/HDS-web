{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 text-center">
            <h1 class="display-5 fw-bold text-dark mb-3">Test de Vulnerabilidad Digital</h1>
            <h3 class="fw-normal text-secondary mb-4">Descubre en 2 minutos c√≥mo de abierta est√° tu puerta digital.</h3>
            <p class="lead text-muted mb-5">Instrucciones: Elige la opci√≥n que m√°s se acerque a lo que har√≠as t√∫. Si una situaci√≥n no aplica a tu vida, elige la D.</p>
                        <div id="test-container" class="card shadow-sm border-0 p-4 p-md-5 text-start">
                <h4 id="question-text" class="fw-bold mb-4" style="line-height: 1.4;">Cargando pregunta...</h4>
                
                <div id="options-container" class="d-grid gap-3">
                    </div>
            </div>

            <div id="result-container" class="card shadow-sm border-0 p-4 p-md-5 d-none">
                <h2 class="fw-bold mb-3">Tu Nivel de Riesgo</h2>
                
                <div class="progress mb-4" style="height: 30px; border-radius: 15px;">
                    <div id="result-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%; font-size: 1.1rem; font-weight: bold;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>

                <h4 id="result-message" class="mb-4" style="line-height: 1.5;">...</h4>
                
                <a href="{% url 'recursos' %}" class="btn btn-primary btn-lg rounded-pill mt-3">
                    <i class="bi bi-bag-plus me-2"></i> Echa un vistazo a estos recursos gratuitos para mejorar tu seguridad
                </a>
            </div>

        </div>
    </div>
</div>

<script>
    // Tus preguntas personalizadas
    // Tus preguntas personalizadas (¬°Ahora con las respuestas mezcladas!)
    const questions = [
        {
            text: "1. Hablemos de tus llaves (Contrase√±as). ¬øCu√°ntas distintas usas para tus cuentas importantes (correo, banco, redes)?",
            options: [
                { text: "A) Unas cuantas. Normalmente uso la misma base pero le cambio el n√∫mero del final o la may√∫scula.", dangerPoints: 5 },
                { text: "B) Son todas distintas y s√∫per largas. Uso un Gestor de Contrase√±as o frases que solo yo recuerdo.", dangerPoints: 0 },
                { text: "C) Una o dos para todo. Tengo muy mala memoria y prefiero ir a lo seguro.", dangerPoints: 10 }
            ]
        },
        {
            text: "2. Entras a tu correo o a tu red social desde un m√≥vil nuevo. Aparte de tu contrase√±a, ¬øte pide algo m√°s?",
            options: [
                { text: "A) S√≠, siempre me pide un c√≥digo SMS, un aviso en mi app o usar mi huella (tengo activado el Doble Factor / 2FA).", dangerPoints: 0 },
                { text: "B) No, pongo la clave y entro directo. ¬°Faltar√≠a m√°s!", dangerPoints: 10 },
                { text: "C) Creo que alguna vez me ha mandado un aviso al m√≥vil, pero me resulta un fastidio.", dangerPoints: 5 }
            ]
        },
        {
            text: "3. Te llega un SMS: \"Tu paquete est√° retenido. Paga 1,99‚Ç¨ en este enlace para liberarlo: [enlace]\". ¬øQu√© haces?",
            options: [
                { text: "A) Borro el SMS al instante. Si espero un paquete, entro a la app oficial o a la web escribi√©ndola yo en Google, nunca desde el SMS.", dangerPoints: 0 },
                { text: "B) Dudo un poco, pero si el mensaje parece real y tiene el logo de Correos, entro a mirar.", dangerPoints: 5 },
                { text: "C) Pincho r√°pido y pago. Pido tantas cosas online que seguro que es algo m√≠o y lo necesito ya.", dangerPoints: 10 }
            ]
        },
        {
            text: "4. üíº [Zona Emprendedoras/Trabajo] Te llega un email urgente de un proveedor diciendo que han cambiado su n√∫mero de cuenta para la pr√≥xima factura, o un aviso de que te van a cerrar la cuenta de Instagram de tu negocio.",
            options: [
                { text: "A) Me extra√±a un poco, pero si el logo de la empresa est√° en el email, supongo que ser√° verdad.", dangerPoints: 5 },
                { text: "B) Llamo por tel√©fono directamente al proveedor al n√∫mero que ya ten√≠a (no al del email) para confirmar, o entro a Instagram por mi cuenta sin tocar el enlace.", dangerPoints: 0 },
                { text: "C) Hago el pago a la nueva cuenta o pincho en el enlace r√°pido para no perder mi Instagram. ¬°El negocio es lo primero y me entra el p√°nico!", dangerPoints: 10 },
                { text: "D) No procede (No tengo un negocio, ni gestiono facturas o clientes).", dangerPoints: 0, isNA: true }
            ]
        },
        {
            text: "5. üëµüë¥ [Zona Familia/Seniors] Recibes un mensaje de WhatsApp desde un n√∫mero desconocido: \"Hola mam√°/pap√°, mi m√≥vil se ha roto, este es mi nuevo n√∫mero y necesito que me hagas un Bizum urgente para pagar una cosa\".",
            options: [
                { text: "A) Le contesto por WhatsApp preguntando qu√© le ha pasado, pero me acabo fiando si me da alg√∫n detalle.", dangerPoints: 5 },
                { text: "B) No env√≠o nada. Intento llamar directamente a mi hijo/a a su n√∫mero de tel√©fono original o pregunto a alguien de la familia antes de soltar un euro.", dangerPoints: 0 },
                { text: "C) Me asusto much√≠simo y hago la transferencia r√°pido para ayudar. ¬°Es una emergencia!", dangerPoints: 10 },
                { text: "D) No procede (No tengo hijos/nietos o no uso WhatsApp para estas cosas).", dangerPoints: 0, isNA: true }
            ]
        },
        {
            text: "6. üì± [Zona J√≥venes/Redes] Est√°s en TikTok, Instagram o jugando online y ves un enlace (o te lo manda un \"amigo\") para conseguir monedas gratis, un filtro exclusivo o ver qui√©n visita tu perfil.",
            options: [
                { text: "A) Paso de largo. S√© que los chollos m√°gicos en internet no existen y que esos enlaces solo quieren robar mi cuenta o mis datos.", dangerPoints: 0 },
                { text: "B) Solo lo hago si me lo manda un amigo por mensaje directo, aunque el mensaje suene un poco raro o est√© en otro idioma.", dangerPoints: 5 },
                { text: "C) Pincho y meto mi usuario sin pensar. ¬°Todo el mundo lo hace y quiero ver qu√© pasa!", dangerPoints: 10 },
                { text: "D) No procede (No uso redes sociales ni juego a videojuegos online).", dangerPoints: 0, isNA: true }
            ]
        },
        {
            text: "7. Tu m√≥vil o tu ordenador te avisa: \"Hay una nueva actualizaci√≥n del sistema disponible\".",
            options: [
                { text: "A) Lo actualizo cuando me acuerdo o cuando el m√≥vil ya se reinicia solo por obligaci√≥n.", dangerPoints: 5 },
                { text: "B) Lo actualizo lo antes posible. S√© que esas actualizaciones son \"vacunas\" contra virus y fallos de seguridad.", dangerPoints: 0 },
                { text: "C) Le doy a \"Recordar ma√±ana\". Y as√≠ llevo seis meses.", dangerPoints: 10 }
            ]
        },
        {
            text: "8. Est√°s tomando algo en una cafeter√≠a o un aeropuerto con Wi-Fi gratis y sin contrase√±a. ¬øQu√© haces?",
            options: [
                { text: "A) Tiro de mis propios datos m√≥viles (4G/5G). No me f√≠o de las redes p√∫blicas abiertas porque cualquiera podr√≠a estar espiando.", dangerPoints: 0 },
                { text: "B) Me conecto, pero solo para mirar redes sociales o buscar algo r√°pido en Google.", dangerPoints: 5 },
                { text: "C) Me conecto de cabeza para no gastar mis datos y aprovecho para hacer una transferencia en la app del banco.", dangerPoints: 10 }
            ]
        }
    ];

    let currentQuestionIndex = 0;
    let totalDangerPoints = 0;
    let maxApplicablePoints = 0; // Se calcula din√°micamente

    // Funci√≥n para cargar la pregunta en pantalla
    function loadQuestion() {
        const q = questions[currentQuestionIndex];
        
        // Formatear el texto de la pregunta para que se vea bien
        document.getElementById('question-text').innerText = q.text;
        
        const optionsDiv = document.getElementById('options-container');
        optionsDiv.innerHTML = ''; // Limpiamos opciones anteriores
        
        q.options.forEach(option => {
            const btn = document.createElement('button');
            // Estilos del bot√≥n: grande, con borde, texto alineado a la izquierda
            btn.className = 'btn btn-outline-secondary btn-lg text-start p-3 shadow-sm';
            // Al pasar el rat√≥n se pone azulito
            btn.style.transition = "all 0.2s";
            
            btn.innerText = option.text;
            btn.onclick = () => selectAnswer(option.dangerPoints, option.isNA || false);
            optionsDiv.appendChild(btn);
        });
    }

    // Funci√≥n que se ejecuta al hacer clic en una respuesta
    function selectAnswer(points, isNA) {
        totalDangerPoints += points;
        
        // Si no han elegido "No procede", sumamos 10 puntos al m√°ximo posible
        if (!isNA) {
            maxApplicablePoints += 10;
        }
        
        currentQuestionIndex++;
        
        // Comprobar si quedan preguntas
        if (currentQuestionIndex < questions.length) {
            loadQuestion(); 
        } else {
            showResults();  
        }
    }

    // Calcular y mostrar la nota final
    function showResults() {
        document.getElementById('test-container').classList.add('d-none');
        document.getElementById('result-container').classList.remove('d-none');
        
        // Evitar error matem√°tico si alguien responde "No procede" a absolutamente todo
        if (maxApplicablePoints === 0) maxApplicablePoints = 10; 

        // Regla de tres para sacar el porcentaje exacto
        let percentage = Math.round((totalDangerPoints / maxApplicablePoints) * 100);
        
        const bar = document.getElementById('result-bar');
        bar.style.width = percentage + '%';
        bar.innerText = percentage + '% Vulnerable';
        
        const messageEl = document.getElementById('result-message');
        
        // Mostrar mensaje personalizado seg√∫n la nota
        if (percentage >= 70) {
            bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-danger';
            messageEl.innerHTML = "üö® <strong>¬°Alerta Roja!</strong> Tienes demasiadas puertas abiertas. Un ciberataque o una estafa es cuesti√≥n de tiempo. Necesitas blindarte urgentemente.";
        } else if (percentage >= 30) {
            bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
            messageEl.innerHTML = "‚ö†Ô∏è <strong>Nivel Medio-Alto.</strong> Haces algunas cosas bien, pero tienes puntos ciegos muy peligrosos. Vamos a cerrarlos cuanto antes.";
        } else if (percentage > 0) {
            bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
            messageEl.innerHTML = "‚úÖ <strong>Buen Nivel.</strong> Vas por buen camino y tienes sentido com√∫n digital, pero a√∫n hay peque√±os detalles que puedes mejorar.";
        } else {
            bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-success';
            messageEl.innerHTML = "üõ°Ô∏è <strong>¬°Escudo de Titanio!</strong> Tienes unos h√°bitos digitales excelentes. Sigue as√≠ y p√°sate por los recursos para mantenerte al d√≠a.";
        }
    }

    // Arrancamos la primera pregunta al abrir la web
    window.onload = loadQuestion;
</script>
{% endblock %}